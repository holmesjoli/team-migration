---
title: EDA
output: md_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
```

```{r}
library(magrittr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)

df <- readr::read_csv("../data/data_v1.0_country-year.csv") %>%
  select(-year)

df_acq <- readr::read_csv("../data/data_v1.0_country-year-mode_acq.csv", na = c("n.a.", "n.a", "")) %>%
  filter(article != "No provision") %>%
  select(-year) %>% 
  mutate(cntry_mode_id = paste(iso3, mode_id, sep = "_"))
  
df_loss <- readr::read_csv("../data/data_v1.0_country-year-mode_loss.csv", na = c("n.a.", "n.a", "")) %>% 
  filter(article != "No provision") %>%
  select(-year) %>%
  mutate(cntry_mode_id = paste(iso3, mode_id, sep = "_"))

df_long <- df %>%
  tidyr::pivot_longer(names_to = "mode_id", values_to = "values", -c(iso3, country, region)) %>% 
  tidyr::separate(mode_id,
                  into = c("mode_id", "type"),
                  sep = "([(_)])") %>%
  mutate(par_mode_id = substr(mode_id, 1, 3),
         acq = grepl("A", mode_id),
         loss = grepl("L", mode_id),
         bin = "bin" == type,
         cat = "cat" == type,
         cntry_mode_id = paste(iso3, mode_id, sep = "_"))
```

## Number of unique codes

```{r}
acq_codes <- df_long %>% filter(acq) %>% distinct(code) %>% pull()
n_acq <- length(acq_codes)

loss_codes <- df_long %>% filter(loss) %>% distinct(code) %>% pull()
n_loss <- length(loss_codes)

n_cntry <- df %>% distinct(country) %>% pull() %>% length()
```

* Number **acquisition** variables: `r n_acq`
* **Acquisition** variables: `r acq_codes`

* Number **loss** variables: `r n_loss`
* **Loss** variables: `r loss_codes`

* Number of countries: `r n_cntry`

## Countries with 99 in A06 code

```{r}
df_long %>%
  filter(bin) %>%
  filter(acq) %>%
  filter(values == 99) %>% 
  distinct(country)
```

## Most common acq codes

```{r}
acq_code_common <- df_long %>%
  filter(bin) %>%
  filter(acq) %>%
  filter(values == 1) %>%
  distinct(code, country, region) %>% 
  group_by(code, region) %>% 
  tally() %>% 
  arrange(desc(n))

ggplot(acq_code_common, aes(x = reorder(code, -n), y = n, fill = reorder(region, n))) +
  geom_bar(stat="identity") +
  labs(y = "N",
       x = "Code",
       title = "Number of countries where a citizen can gain citizenship by code") +
  ylim(0, n_cntry)
```

```{r}
loss_code_common <- df_long %>%
  filter(bin) %>%
  filter(loss) %>%
  filter(values == 1) %>%
  distinct(code, country, region) %>% 
  group_by(code, region) %>% 
  tally() %>% 
  arrange(desc(n))

ggplot(loss_code_common, aes(x = reorder(code, -n), y = n, fill = reorder(region, n))) +
  geom_bar(stat="identity") +
  labs(y = "N",
       x = "Code",
       title = "Number of countries where a citizen can lose citizenship by code") +
  ylim(0, n_cntry)
```

## Acquiring citizenship by country

```{r}
acq_top_10 <- df_long %>%
    filter(bin) %>%
    filter(acq) %>%
    filter(values == 1) %>% 
    group_by(country, region) %>% 
    tally() %>% 
    arrange(n) %>%
    ungroup()

ggplot(acq_top_10 %>% 
    slice(1:10), 
       aes(x = reorder(country, n), y = n)) +
  geom_bar(stat="identity") +
  labs(y = "N",
       x = "Country",
       title = "Top ten countries with the fewest ways to acquire citizenship") +
   theme(axis.text.x = element_text(angle = 65, vjust = 0.5, hjust=1))
```
```{r}
ggplot(acq_top_10,
       aes(x = n, fill = region, color = region)) +
  geom_density(alpha = .5) +
  labs(y = "Density",
       x = "Number",
       title = "Number of ways to acquire citizenship by country") +
   theme(axis.text.x = element_text(angle = 65, hjust=1))
```


* Median number of ways to acquire citizenship: `r median(acq_top_10$n)`

## Losing citizenship by country

```{r}
loss_top_10 <- df_long %>%
    filter(bin) %>%
    filter(loss) %>%
    filter(values == 1) %>% 
    group_by(country, region) %>% 
    tally() %>% 
    arrange(desc(n)) %>%
    ungroup()

ggplot(loss_top_10 %>% 
    slice(1:10), 
       aes(x = reorder(country, -n), y = n)) +
  geom_bar(stat="identity") +
  labs(y = "N",
       x = "Country",
       title = "Top ten countries with the most ways to lose citizenship") +
   theme(axis.text.x = element_text(angle = 65, vjust = 0.5, hjust=1))
```

```{r}
ggplot(loss_top_10,
       aes(x = n, fill = region, color = region)) +
  geom_density(alpha = .5) +
  labs(y = "Density",
       x = "Number",
       title = "Number of ways to lose citizenship by country") +
   theme(axis.text.x = element_text(angle = 65, hjust=1))
```

* Median number of ways to lose citizenship: `r median(loss_top_10$n)`

## Initial Observations

* All countries share at one way to gain citizenship (A01)
* There isn't one universal way citizens can lose citizenship
* L13 doesn't apply to any countries in Africa, Oceania, or the Americas
* The average European country has more ways to acquire citizenship than the average country from another region of the world
* There is a more uniform distribution across how many ways there are to lose citizenship
